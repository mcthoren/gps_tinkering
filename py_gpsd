#!/usr/bin/env python
# -*- coding: utf-8 -*-
# this code indented with actual 0x09 tabs

from gps import *
import time, datetime

base_dir = "/import/home/ghz"

wx_dir = base_dir+'/projects/gps'
wxlib_dir = base_dir+'/wxlib'
sys.path.append(wxlib_dir)
import wxlib as wx

gps_inst = gps(mode=WATCH_ENABLE|WATCH_NEWSTYLE)

vdop = alt = sat_count = epv = gtime = gmode = 0
alt_lst = []

time0 = time1 = time.time()
while True:
	report = gps_inst.next()
	# print report	# for debugging
	if (report['class'] == 'SKY'):
		sat_count = 0
		for i in report['satellites']:
			if i['used']:
				sat_count += 1
		vdop = getattr(report, 'vdop', '0.0')

	if (report['class'] == 'TPV'):
		alt = getattr(report, 'alt', '0.0')
		epv = getattr(report, 'epv', '0.0')
		gtime = getattr(report, 'time', '0.0')
		gmode = getattr(report, 'mode', '0.0')

	if (gmode == 3 and sat_count != 0):
		print "time: %s\talt: %sm\tepv: %sm\tvdop: %s\tsat_count: %s" % (gtime, alt, epv, vdop, sat_count)

		if (vdop < 2.0): # ignore lower quality data
			alt_lst.append((alt, epv))

		lst_len = len(alt_lst)
		avg_alt = sum(a[0] for a in alt_lst) / lst_len
		avg_evp = sum(a[1] for a in alt_lst) / lst_len
		print "avg alt: %.1fm, avg evp: %.1fm" % (avg_alt, avg_evp)

	print "len: %d" % len(alt_lst)

	time1 = time.time()
	if ((time1 - time0) > 60 and len(alt_lst) >= 1024):
		ts =  datetime.datetime.fromtimestamp(time1).strftime("%Y%m%d%H%M%S")
		dat_string = "%s\tavg alt: %.1fm\tavg evp: %.1fm\n" % (ts, avg_alt, avg_evp)
		wx.write_out_dat_stamp(ts, 'gps_alt.dat', dat_string, wx_dir)
		time0 = time1 = time.time()

	if (len(alt_lst) > 1024):
		alt_lst.remove(alt_lst[0])
